## 임계 영역, 이벤트

### 임계 영역 (critical section)

임계 영역(critical section)은 둘 이상의 스레드가 공유 자원에 접근할 때, 오직 한 스레드만 접근을 허용해야 하는 경우에 사용합니다. 임계 영역은 대표적인 스레드 동기화 기법이지만, **생성과 사용법이 달라서 동기화 객체로 분류하지는 않습니다.**

임계 영역은 일반 동기화 객체와 달리 개별 **프로세스의 유저(user) 메모리 영역에 존재하는 단순한 구조체입니다.** 따라서 다른 프로세스가 접근할 수 없으므로 \*한 프로세스에 속한 스레드 간 동기화에만 사용합니다. 일반 동기화 객체보다 빠르고 효율적입니다.

#### 임계 영역 사용 시 주의점

임계 영역을 이용할 때 임계 영역을 이용해 공유 자원 접근을 제한하는 것으로 스레드 동기화 문제를 해결했다고 생각하는 것을 주의해야 합니다. 반드시 기억해야 하는 것은 임계 영역만으로는 어느 스레드가 먼저 리소스를 사용할지 결정할 수 없다는 것입니다. 즉, 어떤 스레드가 먼저 접근할 지 알 수 없습니다.

### 이벤트(event)

이벤트(event)는 사건 발생을 다른 스레드에 알리는 동기화 기법입니다.
이벤트를 사용하는 전형적인 절차는 다음과 같습니다.

- 이벤트를 비신호 상태로 생성
- 한 스레드가 작업을 진행하고 나머지 스레드는 이벤트에 대해 `Wait()` 함수를 호출해 이벤트가 신호 상태가 될 때가지 대기합니다. (sleep)
- 스레드가 작업을 완료하면 이벤트를 신호 상태로 바꿉니다.
- 기다리고 있던 스레드 중 하나 혹은 전부가 깨어납니다. (wake up)

이벤트는 대표적인 동기화 객체로, 신호와 비신호 2가지 상태를 가집니다. 또한 상태를 변경할 수 있도록 다음과 같은 함수가 제공됩니다.

`BOOL SetEvent(HANDLE hEvent); 비신호 -> 신호`
`BOOL ResetEvent(HANDLE hEvent); 신호 -> 비신호`

이벤트는 특성에 따라 2종류가 있으며, 용도에 맞게 선택할 수 있어야 합니다.

- 자동 리셋(auto-reset) 이벤트

  이벤트를 신호상태로 바꾸면, 기다리고 있는 스레드 중 하나만 깨운 후 자동으로 비신호 상태가 됩니다. 즉, 자동 리셋 이벤트에 대해서는 ResetEvent() 함수를 사용할 필요가 없습니다.

- 수동 리셋(manual-reset) 이벤트

  이벤트를 신호 상태로 바꾸면, 기다리고 있는 스레드를 모두 깨운 후 계속 신호 상태를 유지합니다. 자동 리셋 이벤트와 달리 비신호 상태로 바꾸려면 명시적으로 ResetEvent() 함수를 호출해야 합니다.

이벤트는 아래 이벤트 생성 함수 CreateEvent()를 사용해 생성합니다.

```c
// 성공: 이벤트 핸들, 실패: NULL
HANDLE CreateEvent(
LPSECURITY_ATTRIBUTES lpEventAttributes,
BOOL bManualReset,
BOOL bInitialState,
LPCTSTR lpName
);
```

- lpEventAttributes

  핸들 상속(handle inheritance)과 보안 디스크립터(security descriptor) 관련 구조체로, 대부분은 기본값인 NULL을 사용하면 됩니다.

- bManualReset

  TRUE면 수동 리셋, FALSE면 자동 리셋 이벤트가 됩니다.

- bInitialState

  TRUE면 신호, FALSE면 비신호 상태로 시작합니다.

- lpName

  이벤트에 부여할 이름입니다. NULL을 사용하면 이름 없는(anonymous) 이벤트가 생성되므로 같은 프로세스에 속한 스레드 간 동기화에만 사용할 수 있습니다. 서로 다른 프로세스에 속한 스레드 간 동기화를 하려면 같은 이름으로 생성해야 합니다.

### 참고 자료

- [스레드 동기화](https://velog.io/@octo__/%EC%8A%A4%EB%A0%88%EB%93%9C-%EB%8F%99%EA%B8%B0%ED%99%94)
